name: Deploy Blue/Green (Zero Downtime)

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: registry.digitalocean.com/decision-lab
  NAMESPACE: decision-lab
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod

    steps:
    # ------------------------
    # Checkout
    # ------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # ------------------------
    # Docker login
    # ------------------------
    - name: Login to DigitalOcean Registry
      run: |
        echo "${{ secrets.DO_REGISTRY_TOKEN }}" | docker login $REGISTRY -u do --password-stdin

    # ------------------------
    # Build & Push images
    # ------------------------
    - name: Build & Push Django
      run: |
        docker build -t $REGISTRY/django:$IMAGE_TAG ./backend
        docker push $REGISTRY/django:$IMAGE_TAG

    - name: Build & Push Rust Worker
      run: |
        docker build -t $REGISTRY/rust-worker:$IMAGE_TAG ./rust_engine
        docker push $REGISTRY/rust-worker:$IMAGE_TAG

    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DO_REGISTRY_TOKEN }}

    - name: Fetch kubeconfig
      run: |
        doctl kubernetes cluster kubeconfig save k8s-rust

    - name: Verify cluster access
      run: kubectl get nodes

    # ------------------------
    # Namespace
    # ------------------------
    - name: Apply Namespace
      run: kubectl apply -f k8s/namespace.yaml --validate=false
    
    - name: Apply ConfigMap
      run: kubectl apply -f k8s/configmap.yaml --validate=false
    
    - name: Apply Cluster Issuer
      run: kubectl apply -f k8s/cluster-issuer.yaml --validate=false
    - name: Apply Ingress
      run: kubectl apply -f k8s/ingress.yaml 
    # ------------------------
    # Secrets
    # ------------------------
    - name: Apply Kubernetes Secrets
      run: |
        kubectl create secret generic backend-secrets \
          --namespace $NAMESPACE \
          --from-literal=DATABASE_URL="${{ secrets.DATABASE_URL }}" \
          --from-literal=REDIS_URL="${{ secrets.REDIS_URL }}" \
          --from-literal=CELERY_BROKER_URL="${{ secrets.CELERY_BROKER_URL }}" \
          --from-literal=DJANGO_SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}" \
          --from-literal=POSTGRES_PASSWORD="${{ secrets.POSTGRES_PASSWORD }}" \
          --from-literal=POSTGRES_USER="${{ secrets.POSTGRES_USER }}" \
          --from-literal=POSTGRES_DB="${{ secrets.POSTGRES_DB }}" \
          --dry-run=client -o yaml | kubectl apply -f -


    - name: Verify image exists
      run: |
        docker manifest inspect $REGISTRY/django:$IMAGE_TAG
    # ------------------------
    # Infra services
    # ------------------------
    - name: Deploy Postgres
      run: kubectl apply -f k8s/base/postgres/

    - name: Deploy Redis
      run: kubectl apply -f k8s/base/redis/

    - name: Deploy RabbitMQ
      run: kubectl apply -f k8s/base/rabbitmq/

    # ------------------------
    # Workers
    # ------------------------
    - name: Deploy Celery Workers
      run: kubectl apply -f k8s/base/workers/

    - name: Deploy Rust Worker
      run: |
        sed "s|IMAGE_TAG|$IMAGE_TAG|g" \
          k8s/base/rust-worker/deployment.yaml | kubectl apply -f -

    # ------------------------
    # Deploy GREEN
    # ------------------------
    - name: Deploy Django Green
      run: |
        sed "s|IMAGE_TAG|$IMAGE_TAG|g" \
          k8s/base/django/deployment-green.yaml | kubectl apply -f -
        kubectl rollout status deployment/django-green -n $NAMESPACE

    - name: Apply HPA for Django
      run: kubectl apply -f k8s/base/django/hpa.yaml

    # ------------------------
    # Internal Healthcheck
    # ------------------------
    - name: Healthcheck Green (internal)
      run: |
        kubectl run curl --rm -i --restart=Never \
          --image=curlimages/curl \
          -- curl -f http://django.$NAMESPACE.svc.cluster.local/api/v1/system/health/

    # ------------------------
    # Switch Blue â†’ Green
    # ------------------------
    - name: Switch Traffic to Green
      if: success()
      run: |
        kubectl patch service django \
          -n $NAMESPACE \
          -p '{"spec":{"selector":{"app":"django","version":"green"}}}'

    # ------------------------
    # Cleanup old BLUE
    # ------------------------
    - name: Cleanup old Blue
      if: success()
      run: |
        kubectl delete deployment django-blue -n $NAMESPACE || true
        kubectl delete hpa django-blue-hpa -n $NAMESPACE || true

    # ------------------------
    # Rollback
    # ------------------------
    - name: Rollback to Blue
      if: failure()
      run: |
        kubectl patch service django \
          -n $NAMESPACE \
          -p '{"spec":{"selector":{"app":"django","version":"blue"}}}'
